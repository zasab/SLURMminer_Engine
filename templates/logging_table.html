{% extends "base.html" %}
{% block title %}Upload BPMN Page{% endblock %}
{% block content %}
    <style>
        .table-container {
            overflow-x: auto;
            width: 100%; 
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            padding: 8px;
            border: 2px solid #1e1313;
            white-space: nowrap; /* Prevent wrapping of cell values */
            font-size: 12px;
        }
        th {
            background-color: #797171;
        }
        .tablecontent {
            width: 100%;
        }
    </style>
    <div class="tablecontent">
        <div class="form-group">
            <label for="search-input">Search:</label>
            <input type="text" class="form-control" id="search-input" placeholder="Enter search term">
            <label for="status-checkbox">Running</label>
            <input type="checkbox" id="status-checkbox" value="Running">
            <button class="btn btn-primary mt-2" id="search-button">Search</button>
        </div>
        <div class="table-container">
            <table id="data-table" class="table">
                <thead>
                    <tr id="header-row">
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be inserted here dynamically -->
                </tbody>
            </table>
        </div>
        <nav aria-label="Page navigation">
            <ul class="pagination">
                <li class="page-item" id="prev-page">
                    <a class="page-link" href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li class="page-item" id="next-page">
                    <a class="page-link" href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="pagination-info">
            <p>Page <span id="current-page">1</span> of <span id="total-pages">1</span></p>
        </div>
    </div>
{% endblock %}

{% block script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    var pageNumber = 1;
    var searchTerm = '';
    var statusValue = $('#status-checkbox').prop('checked') ? 'running' : '';

    // Function to fetch data from the API based on page number and search term
    function populateTable(pageNumber, searchTerm, statusValue) {
        $.ajax({
            url: '/start_logging',
            type: 'GET',
            dataType: 'json',
            data: {
                page: pageNumber,
                items_per_page: 10,
                search_term: searchTerm,
                status_value: statusValue
            },
            success: function(data) {
                var thead = $('#header-row');
                var tbody = $('#data-table tbody');
                tbody.empty();
                if (data.data.length > 0) {
                    var firstItem = data.data[0];
                    var headerRow = '';
                    for (var key in firstItem) {
                        headerRow += '<th>' + key + '</th>';
                    }
                    thead.html(headerRow);
                }

                data.data.forEach(function(item) {
                    var row = '<tr>';
                    for (var key in item) {
                        row += '<td>' + item[key] + '</td>';
                    }
                    row += '</tr>';
                    tbody.append(row);
                });

                // Update pagination info
                updatePaginationInfo(data.current_page, data.total_pages);
            },
            error: function(error) {
                console.error('Error fetching data from the API:', error.message);
                console.error('Status code:', error.status);
            }
        });
    }

    // Function to fetch data for the initial page load
    function loadInitialData() {
        populateTable(pageNumber, searchTerm, statusValue);
    }

    $(document).ready(function() {
        // Load initial data on page load
        loadInitialData();
        // Function to handle search button click event
        function handleSearch() {
            searchTerm = $('#search-input').val().toLowerCase();
            statusValue = $('#status-checkbox').prop('checked') ? 'running' : '';
            if (searchTerm.trim() === '') {
                // If search term is empty, load initial data
                loadInitialData();
            } else {
                // Fetch data based on search term
                populateTable(1, searchTerm, statusValue); // Start from the first page when searching
            }
        }

        $('#search-button').on('click', handleSearch);

        function showNextPage() {
            pageNumber++;
            populateTable(pageNumber, searchTerm, statusValue); // Pass the search term to the function
        }

        function showPreviousPage() {
            if (pageNumber > 1) {
                pageNumber--;
                populateTable(pageNumber, searchTerm, statusValue); // Pass the search term to the function
            }
        }

        $('#next-page').on('click', showNextPage);
        $('#prev-page').on('click', showPreviousPage);

        // ... (existing code for pagination info update)

    });
    // Update pagination info
    function updatePaginationInfo(currentPage, totalPages) {
        $('#current-page').text(currentPage);
        $('#total-pages').text(totalPages);
    }

</script>
{% endblock %}
